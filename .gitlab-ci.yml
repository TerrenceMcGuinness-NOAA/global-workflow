stages:
  - mirror

variables:
  DOCKER_REGISTRY: "docker.io"
  DOCKER_IMAGE: "alpine:latest"

mirror:
  stage: mirror
  before_script:
    - apk update
    - apk add --no-cache git openssh-keygen openssh-client-default github-cli jq
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
  script:
    - TIMESTAMP=$(date +%s)
    - DIR_NAME="git_sync_$TIMESTAMP"
    - mkdir -p $DIR_NAME
    - cd $DIR_NAME
    - git init
    - git remote add origin $CI_REPOSITORY_URL
    - git remote add upstream $GITHUB_REPO_URL
    - git fetch upstream
    - git reset --hard upstream/$CI_DEFAULT_BRANCH
    - git push -f "https://${GITLAB_USER_LOGIN}:${ACCESS_TOKEN}@${CI_REPOSITORY_URL#*@}" "HEAD:${CI_DEFAULT_BRANCH}"
    - echo $GITHUB_TOKEN | xargs gh auth login --with-token
    - for pr in $(gh pr list --state open --json number --jq '.[].number'); do
        gh pr checkout $pr;
        git push -f "https://${GITLAB_USER_LOGIN}:${ACCESS_TOKEN}@${CI_REPOSITORY_URL#*@}" "HEAD:pr-$pr";
      done
  only:
    - schedules
